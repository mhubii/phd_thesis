\begin{algorithm}
\caption{A recap of the robust Lie group formulation of the point-to-plane \gls{icp}. Refers to \secref{c1:sec:robust_icp}.}\label{c1:alg:liep2plan}
\begin{algorithmic}
\State Let $\{\mathbf{p}\}$ be points to match (the observations). We omit the indices for simplicity here
\State Let $\{\mathbf{q},\mathbf{n}\}$ be points with associated normals (the model)
\State Let $t \gets 0$ be a counter for the outer iterations
\State Let $\mathbf{\Theta}_0 = \{\mathbf{R}_0,\mathbf{t}_0\}$ be an initial estimate of the transformation parameters
\While{ICP not converged}
  \State Compute the transformed points $\mathbf{\Theta}_t \mathbf{p}$
  \State Perform an approximate nearest neighbour search to match $\mathbf{\Theta}_t, \mathbf{p}$, and $\mathbf{q}$ points
  \State Discard point pairs associated with distances that are definitely outliers
  \State We now use $i$ indices to indicated matching points
  \State Compute the residuals: $b_i \gets \tilde{\mathbf{n}}_i^T (\tilde{\mathbf{q}}_i - \mathbf{R}_t \tilde{\mathbf{p}}_i - \mathbf{t}_t)$
  \State \Comment{Previous computation of $\mathbf{\Theta}_t \mathbf{p}$ should of course be re-used here}
  \State Compute the robust standard deviation: $\sigma \gets \MAD(\{b_i\})/0.6745$
  \State \Comment{Done once to avoid recomputing it in the inner iterations}
  \State Let $\tau \gets 0$ be a counter for the inner iterations
  \State Let $\mathbf{\Theta}_{t,0} \gets \mathbf{\Theta}_{t}$ be the current estimate of the transformation
  \While{Gauss-Newton not converged}
    \If{$\tau \neq 0$}
      \State Compute the residuals: $b_i \gets \tilde{\mathbf{n}}_i^T (\tilde{\mathbf{q}}_i - \mathbf{R}_{t,\tau} \tilde{\mathbf{p}}_i - \mathbf{t}_{t,\tau})$
    \EndIf
    \State Compute the robust weights: $\omega_i \gets \omega_{1.345\sigma}(b_i)$
    \State Compute the linear coefficients: $\mathbf{a}_i \gets [-\tilde{\mathbf{n}}_i^T \mathbf{R}_{t,\tau} {{\tilde{\mathbf{p}}}_{i\times}}, \tilde{\mathbf{n}}_i^T \mathbf{R}_{t,\tau}]$
    \State Solve the weighted normal equation:
    \State \quad $\Delta\mathbf{\Theta} \gets \texttt{chol\_solve}(\mathbf{A}^T \mathbf{W} \mathbf{A}, \mathbf{A}^T \mathbf{W} \mathbf{A})$
    \State Update the transformation: $\mathbf{\Theta}_{t,\tau+1} \gets \mathbf{\Theta}_{t,\tau} \cdot \exp(\Delta\mathbf{\Theta})$
    \State $\tau \gets \tau+1$
  \EndWhile
  \State Let $\mathbf{\Theta}_{t+1} \gets \mathbf{\Theta}_{t,\tau}$
  \State $t \gets t+1$
\EndWhile
%\Require $n \geq 0$
%\Ensure $y = x^n$
%\State $y \gets 1$
%\State $X \gets x$
%\State $N \gets n$
%\While{not converged}
%\If{$N$ is even}
%    \State $X \gets X \times X$
%    \State $N \gets \frac{N}{2}$  \Comment{This is a comment}
%\ElsIf{$N$ is odd}
%    \State $y \gets y \times X$
%    \State $N \gets N - 1$
%\EndIf
%\EndWhile
\end{algorithmic}
\end{algorithm}